{% extends "base.html" %}

{% block title %}Login - Task Board Management System{% endblock %}

{% block content %}
<div class="login-container">
  <div class="login-logo">
    <i class="fas fa-tasks fa-3x text-primary mb-3"></i>
    <h2>Task Board</h2>
    <p class="text-muted">Sign in to access your boards</p>
  </div>
  
  <div class="alert alert-danger d-none" id="login-error" role="alert"></div>
  
  <form id="login-form">
    <div class="mb-3">
      <label for="email" class="form-label">Email address</label>
      <input type="email" class="form-control" id="email" name="email" required>
    </div>
    
    <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <input type="password" class="form-control" id="password" name="password" required>
    </div>
    
    <div class="d-grid gap-2">
      <button type="submit" class="btn btn-primary" id="login-submit">
        <i class="fas fa-sign-in-alt me-2"></i> Log In
      </button>
      
      <div class="text-center my-3">
        <span class="text-muted">Don't have an account?</span>
      </div>
      
      <a href="/register" class="btn btn-outline-secondary">
        <i class="fas fa-user-plus me-2"></i> Create Account
      </a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('login-form');
    
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Get form values
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      // Show loading state
      const submitBtn = document.getElementById('login-submit');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Logging in...';
      
      try {
        // Sign in with Firebase Authentication
        const auth = firebase.auth();
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Get user ID token
        const idToken = await user.getIdToken();
        
        // Send token to backend to create session
        const response = await fetch('/api/auth/session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            idToken: idToken
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Failed to log in');
        }
        
        const data = await response.json();
        
        // Redirect to dashboard
        window.location.href = data.redirect || '/dashboard';
        
      } catch (error) {
        // Show error message
        const errorElement = document.getElementById('login-error');
        
        // Format Firebase error messages
        let errorMessage = 'Failed to log in';
        if (error.code) {
          switch (error.code) {
            case 'auth/user-not-found':
              errorMessage = 'No account found with this email address';
              break;
            case 'auth/wrong-password':
              errorMessage = 'Incorrect password';
              break;
            case 'auth/invalid-email':
              errorMessage = 'Invalid email format';
              break;
            case 'auth/user-disabled':
              errorMessage = 'This account has been disabled';
              break;
            default:
              errorMessage = error.message || 'Authentication failed';
          }
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        errorElement.textContent = errorMessage;
        errorElement.classList.remove('d-none');
        
        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });
  });
</script>
{% endblock %}
