{% extends "base.html" %}

{% block title %}{{ board.name }} - Task Board Management System{% endblock %}

{% block head %}
<script src="/static/js/boards.js"></script>
<script src="/static/js/tasks.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">{{ board.name }}</li>
      </ol>
    </nav>
    
    <h1 class="mb-0">
      <i class="fas fa-clipboard-list me-2"></i>
      {{ board.name }}
      
      {% if board.owner_id == user_id %}
        <span class="badge bg-warning ms-2">
          <i class="fas fa-crown"></i> Owner
        </span>
      {% endif %}
    </h1>
  </div>
  
  <div>
    {% if board.owner_id == user_id %}
      <div class="btn-group">
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
          <i class="fas fa-user-plus me-1"></i> Add User
        </button>
        
        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#renameBoardModal">
          <i class="fas fa-edit me-1"></i> Rename
        </button>
        
        <form action="/boards/{{ board.id }}/delete" method="post" class="d-inline">
          <button type="submit" id="delete-board-btn" class="btn btn-outline-danger">
            <i class="fas fa-trash-alt me-1"></i> Delete
          </button>
        </form>
      </div>
    {% endif %}
  </div>
</div>

<!-- Task Stats -->
<div class="task-stats mb-4">
  <div class="task-stat-item bg-primary bg-opacity-10 text-primary">
    <div class="task-stat-value">{{ stats.total }}</div>
    <div class="task-stat-label">Total Tasks</div>
  </div>
  
  <div class="task-stat-item bg-success bg-opacity-10 text-success">
    <div class="task-stat-value">{{ stats.completed }}</div>
    <div class="task-stat-label">Completed</div>
  </div>
  
  <div class="task-stat-item bg-warning bg-opacity-10 text-warning">
    <div class="task-stat-value">{{ stats.active }}</div>
    <div class="task-stat-label">Active</div>
  </div>
</div>

<div class="row">
  <!-- Tasks Column -->
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="fas fa-tasks me-2"></i>
          Tasks
        </h5>
        
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createTaskModal">
          <i class="fas fa-plus me-1"></i> Add Task
        </button>
      </div>
      
      <div class="card-body">
        {% if tasks %}
          <div class="list-group">
            {% for task in tasks %}
              <div class="list-group-item task-card {% if task.completed %}completed{% endif %} {% if task.unassigned %}unassigned{% endif %}">
                <div class="d-flex w-100 justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <form action="/tasks/{{ task.id }}/toggle-complete" method="post" class="me-3">
                      <div class="form-check">
                        <input class="form-check-input task-complete-checkbox" type="checkbox" {% if task.completed %}checked{% endif %}>
                      </div>
                    </form>
                    
                    <div>
                      <h5 class="mb-1 {% if task.completed %}text-decoration-line-through{% endif %}">
                        {{ task.title }}
                      </h5>
                      
                      <div class="d-flex align-items-center mt-2">
                        <span class="badge {% if task.unassigned %}bg-danger{% else %}bg-secondary{% endif %} me-2">
                          {% if task.unassigned %}
                            <i class="fas fa-exclamation-circle me-1"></i> Unassigned
                          {% elif task.assigned_to|length == 0 %}
                            <i class="fas fa-user-slash me-1"></i> No assignees
                          {% else %}
                            <i class="fas fa-users me-1"></i> {{ task.assigned_to|length }} assignee(s)
                          {% endif %}
                        </span>
                        
                        <span class="due-date due-date-display" data-due-date="{{ task.due_date }}">
                          Due: {{ task.due_date.strftime('%Y-%m-%d %H:%M') }}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editTaskModal-{{ task.id }}">
                          <i class="fas fa-edit me-2"></i> Edit
                        </button>
                      </li>
                      
                      <li>
                        <button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#assignTaskModal-{{ task.id }}">
                          <i class="fas fa-user-tag me-2"></i> Assign
                        </button>
                      </li>
                      
                      <li><hr class="dropdown-divider"></li>
                      
                      <li>
                        <form action="/tasks/{{ task.id }}/delete" method="post">
                          <button type="submit" class="dropdown-item text-danger delete-task-btn">
                            <i class="fas fa-trash-alt me-2"></i> Delete
                          </button>
                        </form>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <!-- Edit Task Modal -->
              <div class="modal fade" id="editTaskModal-{{ task.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <form class="edit-task-form" action="/tasks/{{ task.id }}/edit" method="post">
                      <div class="modal-header">
                        <h5 class="modal-title">
                          <i class="fas fa-edit me-2"></i>
                          Edit Task
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      
                      <div class="modal-body">
                        <div class="mb-3">
                          <label for="edit-task-title-{{ task.id }}" class="form-label">Task Title</label>
                          <input type="text" class="form-control task-title-input" id="edit-task-title-{{ task.id }}" name="title" value="{{ task.title }}" required>
                        </div>
                        
                        <div class="mb-3">
                          <label for="edit-task-due-date-{{ task.id }}" class="form-label">Due Date</label>
                          <input type="datetime-local" class="form-control due-date-input" id="edit-task-due-date-{{ task.id }}" name="due_date" value="{{ task.due_date.strftime('%Y-%m-%dT%H:%M') }}" required>
                        </div>
                      </div>
                      
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              
              <!-- Assign Task Modal -->
              <div class="modal fade" id="assignTaskModal-{{ task.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <form class="assign-task-form" action="/tasks/{{ task.id }}/assign" method="post">
                      <div class="modal-header">
                        <h5 class="modal-title">
                          <i class="fas fa-user-tag me-2"></i>
                          Assign Task
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      
                      <div class="modal-body">
                        <div class="mb-3">
                          <label for="assign-users-{{ task.id }}" class="form-label">Assign To</label>
                          <select class="form-select" id="assign-users-{{ task.id }}" name="assigned_to" multiple>
                            {% for member in members %}
                              <option value="{{ member.id }}" {% if member.id in task.assigned_to %}selected{% endif %}>
                                {{ member.display_name }} {% if member.id == board.owner_id %}(Owner){% endif %}
                              </option>
                            {% endfor %}
                          </select>
                          <div class="form-text">Leave empty for unassigned task</div>
                        </div>
                      </div>
                      
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Assign</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-4">
            <div class="mb-3">
              <i class="fas fa-clipboard-check text-muted fa-4x"></i>
            </div>
            <h5>No tasks yet</h5>
            <p class="text-muted">Create your first task to get started</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
              <i class="fas fa-plus me-1"></i> Add Task
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Members Column -->
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-users me-2"></i>
          Members ({{ members|length }})
        </h5>
      </div>
      
      <div class="card-body">
        <ul class="list-group">
          {% for member in members %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div class="d-flex align-items-center">
                  <div class="bg-primary bg-opacity-25 rounded-circle p-2 me-2">
                    <i class="fas fa-user text-primary"></i>
                  </div>
                  
                  <div>
                    <div>{{ member.display_name }}</div>
                    <small class="text-muted">{{ member.email }}</small>
                  </div>
                </div>
              </div>
              
              <div>
                {% if member.id == board.owner_id %}
                  <span class="badge bg-warning">
                    <i class="fas fa-crown"></i> Owner
                  </span>
                {% elif board.owner_id == user_id %}
                  <form action="/boards/{{ board.id }}/remove-user" method="post" class="d-inline">
                    <input type="hidden" name="remove_user_id" value="{{ member.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger remove-user-btn" data-user-name="{{ member.display_name }}">
                      <i class="fas fa-user-minus"></i>
                    </button>
                  </form>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="create-task-form" action="/tasks/create" method="post">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-plus-circle me-2"></i>
            Add New Task
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="task-error" role="alert"></div>
          
          <input type="hidden" name="board_id" value="{{ board.id }}">
          
          <div class="mb-3">
            <label for="task-title" class="form-label">Task Title</label>
            <input type="text" class="form-control" id="task-title" name="title" required>
          </div>
          
          <div class="mb-3">
            <label for="task-due-date" class="form-label">Due Date</label>
            <input type="datetime-local" class="form-control due-date-input" id="task-due-date" name="due_date" required>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Rename Board Modal -->
<div class="modal fade" id="renameBoardModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="rename-board-form" action="/boards/{{ board.id }}/rename" method="post">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>
            Rename Board
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="rename-error" role="alert"></div>
          
          <div class="mb-3">
            <label for="edit-board-name" class="form-label">Board Name</label>
            <input type="text" class="form-control" id="edit-board-name" name="name" value="{{ board.name }}" required>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="add-user-form" action="/boards/{{ board.id }}/add-user" method="post">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-user-plus me-2"></i>
            Add User to Board
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="add-user-error" role="alert"></div>
          
          <div class="mb-3">
            <label for="user-email" class="form-label">User Email</label>
            <input type="email" class="form-control" id="user-email" name="email" required>
            <div class="form-text">Enter the email address of the user you want to add</div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add User</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
